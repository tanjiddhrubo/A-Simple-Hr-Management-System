@model IEnumerable<A_Simple_Hr_Management_System.Models.Company>

@{
    ViewData["Title"] = "Companies";
}

<h1>Company List</h1>
<p>
    <button type="button" class="btn btn-primary" id="createNewCompanyBtn">
        Create New Company
    </button>
</p>

<table class="table" id="companyTable">
    <thead>
        <tr>
            <th>Company Name</th>
            <th>Basic (%)</th>
            <th>House Rent (%)</th>
            <th>Medical (%)</th>
            <th>Is Inactive</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var company in Model)
        {
            <tr>
                <td>@company.ComName</td>
                <td>@company.Basic</td>
                <td>@company.Hrent</td>
                <td>@company.Medical</td>
                <td>@company.IsInactive</td>
                <td>
                    @Html.AntiForgeryToken() <a asp-action="Edit" asp-route-id="@company.ComId" class="btn btn-sm btn-info js-edit">Edit</a>
                    <button data-id="@company.ComId" class="btn btn-sm btn-danger js-delete">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="companyModalLabel">Create New Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>
     
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            var modal = new bootstrap.Modal(document.getElementById('companyModal'), {});
            var modalTitle = $('#companyModalLabel');
            var modalBody = $('#companyModal .modal-body');

            // --- CREATE MODAL LOGIC ---
            $('#createNewCompanyBtn').on('click', function () {
                modalTitle.text('Create New Company');
                $.get('/Company/Create', function (data) {
                    modalBody.html(data);
                    $.validator.unobtrusive.parse($('#createCompanyForm'));
                    modal.show();
                });
            });

            $('#companyModal').on('submit', '#createCompanyForm', function (e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    url: '/Company/CreateAjax',
                    type: 'POST',
                    data: form.serialize(),
                    headers: { RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                    success: function (data) {
                        if (data.success) {
                            modal.hide();
                            location.reload();
                        }
                    }
                });
            });

            // --- EDIT MODAL LOGIC ---
            $('#companyTable').on('click', '.js-edit', function (e) {
                e.preventDefault();
                var button = $(this);
                modalTitle.text('Edit Company');
                $.get(button.attr("href"), function (data) {
                    modalBody.html(data);
                    $.validator.unobtrusive.parse($('#editCompanyForm'));
                    modal.show();
                });
            });

            $('#companyModal').on('submit', '#editCompanyForm', function (e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    url: '/Company/EditAjax',
                    type: 'POST',
                    data: form.serialize(),
                    headers: { RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                    success: function (data) {
                        if (data.success) {
                            modal.hide();
                            location.reload();
                        }
                    }
                });
            });

            // --- DELETE AJAX LOGIC ---
            $('#companyTable').on('click', '.js-delete', function () {
                var button = $(this);
                if (confirm("Are you sure you want to delete this company?")) {
                    $.ajax({
                        url: '/Company/DeleteAjax',
                        type: 'POST',
                        data: { id: button.attr('data-id') },
                        headers: { RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                        success: function (data) {
                            if (data.success) {
                                button.closest('tr').fadeOut(500, function () { $(this).remove(); });
                            } else {
                                alert(data.message);
                            }
                        },
                        error: function () {
                            alert("An error occurred while deleting.");
                        }
                    });
                }
            });
        });
    </script>
}